---
title: React Fiber 에 대하여
date: 2025-01-06
desc: React Fiber에 대한 공부 내용을 정리해보겠습니다.
thumbnail: /posts/react/react_fiber/react_fiber_2.jpg
---

> React Fiber에 대해서 정리해보려고 합니다. 머리에 잘 안들어오는 개념이기도 하고 저번 기술면접때 질문을 받았었을때 렌더링 과정에서 쓰이는 기술이다 라고 어설프게 답변을 했고 구체적으로 답변을 하지 못해 아쉬운 기억이 있습니다.💦 이번 기회에 제 방식대로 공부하고 이해한 내용을 기록해보겠습니다.😊
> - Fiber 소개영상 : https://youtu.be/ZCuYPiUIONs
## 📌 리액트의 렌더링 프로세스
먼저 React Fiber에 대해 들어가기 전에 리액트의 렌더링 프로세스에 대해 간략하게 한번 짚어보고 가겠습니다.
> 1. 트리거 : createRoot의 실행(최초 실행) 혹은 state를 업데이트하게 되면 발생합니다.
> 2. 렌더링 (리렌더링) : createRoot로 렌더링이 발생했다면 루트 컴포넌트를 호출하고 state의 업데이트로 인한 렌더링이라면 해당 state가 속해있는 컴포넌트를 호출합니다.
> 3. 커밋 : 바뀐 부분을 실제 DOM에 적용하는 과정입니다. 첫 커밋이라면 appendChild를 사용해서 모든 노드를 생성하는데 첫 커밋이 아니라면 **바뀐 부분**만 찾아서 실제 DOM에 적용합니다.

실제 바뀐 부분을 찾는 과정은 재조정(reconciliation) 과정입니다. 실제 DOM과 가상 DOM을 비교하면서 바뀐 부분을 찾는 과정인데 React v16 이전에는 재조정 과정이 Stack reconciler 모듈에서 일어났습니다. 
이 Stack Reconciler의 동작 방식에 대해 자세히 알아 보겠습니다.

---

## 📌 Stack Reconciler
Stack Reconciler는 React v16 이전에 사용되던 렌더링 알고리즘입니다.

### Stack Reconciler의 동작 방식
> 1. DOM트리의 루트부터 재귀 형식으로 컴포넌트를 만날때마다 `.render()` 호출
> 2. 이전 DOM트리와 비교하며 업데이트가 필요한 컴포넌트인지 확인하고 해당 컴포넌트의 자식 컴포넌트도 업데이트 필요한지 확인
> 3. 컴포넌트들을 하나씩 업데이트

이렇게 Stack Reconciler는 동기적으로 컴포넌트별로 화면을 렌더링하는데 이 방식에서는 변경 사항이 발생할 때마다 루트부터 탐색해서 모든 컴포넌트를 업데이트해서 문제가 발생할 수 있습니다. 많은 컴포넌트를 동시에 업데이트 하거나 연산이 큰 작업이 있을 경우 **화면 버벅임**이나 **프레임 드랍** 현상이 발생할 수 있습니다. 모든 컴포넌트를 순차적으로 렌더링하는 방식은 효율적이지 않을 수 있으며, 시간이 많이 걸리는 작업을 처리할때나 애니메이션과 같은 정밀한 작업에서 사용자 경험에 안 좋은 영향을 미칠 수 있습니다.

---

## 📌 Fiber Reconciler

Fiber Reconciler는 React v16에서 도입된 새로운 렌더링 알고리즘으로, Stack Reconciler를 보완하고 성능을 개선하기 위해 설계되었습니다. React는 UI 업데이트를 할 때, 효율적으로 작업을 분리하고 비동기적으로 처리하려는 목표를 가지고 Fiber 아키텍처를 도입했습니다. Fiber는 렌더링 과정에서 발생하는 UI 업데이트를 더 세밀하게 제어할 수 있게 해줍니다.

### Fiber Reconciler의 주요 기능
> - 작업을 멈추고 다시 수행할 수 있는 기능
> - 작업별로 우선순위를 부여할 수 있는 기능
> - 이전에 완료된 작업을 재사용할 수 있는 기능
> - 필요가 없어진 작업을 중간에 취소하는 기능

Fiber Reconciler는 이런식의 기능을 하기 위해 작업 단위를 Fiber라는 객체로서 세분화 합니다. Fiber는 React 컴포넌트에 대한 세부 정보를 포함하고 있으며, 각 컴포넌트의 상태, 속성, 렌더링 정보 등을 세분화하여 관리합니다. 이를 통해 React는 비동기적으로 컴포넌트를 업데이트하고 효율적으로 렌더링할 수 있습니다.
> Fiber는 비동기 렌더링을 지원하며, 업데이트할 컴포넌트들에게 우선순위를 부여하여 작업의 중요도를 기준으로 처리합니다. 이를 통해 React는 사용자 경험을 최적화할 수 있습니다.

예를 들어, 다양한 작업이 동시에 발생하는 상황에서, API 호출, 애니메이션, 버튼 클릭 등의 작업이 있을 때, React는 이들 각각에 우선순위를 두어 순차적으로 처리합니다. 일반적으로 애니메이션 작업은 빠른 응답을 요구하므로 높은 우선순위를 부여하고, 그 다음으로 중요한 작업인 API 호출과 버튼 클릭 순으로 처리하여, **프레임 드랍**이나 **버벅임**을 방지하며 매끄러운 사용자 경험을 제공합니다.

이처럼 Fiber는 렌더링을 더 세밀하게 제어하여, 화면의 부드러움과 성능을 동시에 유지할 수 있도록 돕습니다.

### Fiber Tree
Fiber에 Reconcilation을 처리하기 위해 존재하는 Fiber Tree의 경우 Stack Reconcilation을 할 때 처럼 Tree가 recursion으로 구현된 것이 아닌, LinkedList로 구현되어 있습니다.(정확히는 LCRS트리라고 불리며, Left Children Right Sibiling의 약자입니다.)

React 에서 Fiber 트리는 현재 모습을 담고 있는 current 트리와 작업 중인 상태를 나타내는 workInProgress 트리로 구성되어 있는데 React 에서는 작업이 끝나면 단순히 포인터만 변경하여 workInPrgress 트리를 현재 트리로 바꿔버립니다. 이러한 현상을 **더블 버퍼링**이라고 하는데 미처 렌더링 하지 못한 부분을 노출 시키지 않기 위해 이러한 기법을 사용하며 커밋 단계에서 수행 됩니다.
> **더블 버퍼링**
컴퓨터 그래픽 분야에서 싱글 버퍼링으로 그래픽을 그릴 경우 미처 다 그리지 못한 모습이 발생한다.
이러한 상황을 방지하기 위해 보이지 않는 곳에서 다음으로 그려야 할 그림을 미리 그린 후 완성되면 현재 상태를 새로운 그림으로 바꾸는 기법이다.

![](/posts/react/react_fiber/fiber_tree.png)

> **그림의 순서**
> 1. 현재 UI 렌더링을 위해 먼저 존재하는 트리인 current를 기준으로 작업이 시작된다.
> 2. 만약 업데이트가 발생하면 Fiber는 새로운 workInProgress 트리를 만든다.
> 3. workInProgress 트리 작업이 끝나면 다음 렌더링에 이 트리를 사용한다.
> 4. workInProgress 트리가 UI에 렌더링되면 current가 workInProgress 트리로 변경된다.

### Fiber 알고리즘
- 렌더 단계: React가 컴포넌트를 업데이트할 필요가 있을 때, 해당 업데이트를 어떻게 처리할지 계획하는 과정입니다. 이 단계에서는 **비동기적**으로 작업이 수행되며, Fiber 객체의 우선순위와 상태를 기반으로 업데이트 작업이 진행됩니다. 렌더 단계에서는 실제로 DOM을 변경하는 작업은 이루어지지 않습니다.
- 커밋 단계: 렌더 단계에서 준비된 변경사항을 실제 DOM에 반영하는 단계입니다. 이 단계에서는 **동기적**으로 모든 작업이 이루어지며, DOM 업데이트가 실제로 발생합니다.

### Fiber 작업 순서
> 1. 리액트는 beginWork() 함수를 실행해 Fiber 작업을 수행한다. 더 이상 자식이 없는 Fiber를 만날 때까지 트리 형식으로 시작한다.
> 2. 1번에서 작업이 끝났다면 그 다음 completeWork() 함수를 실행해 Fiber 작업을 완료한다.
> 3. 형제가 있다면 형제로 넘어간다.
> 4. 2번, 3번이 모두 끝나면 return으로 돌아가 자신의 작업이 완료됐음을 알린다.

![생성된 Fiber Tree](/posts/react/react_fiber/fiber_tree_2.webp)

Fiber Tree는 기존에 생성된 Fiber Tree를 재활용하여, 변경된 props만 다시 받아와 업데이트를 진행합니다. 이는 기존의 Stack Reconciler와 달리 매번 재귀적으로 새로운 트리를 생성하지 않기 때문에 더 효율적입니다. 또한, 이제는 각 작업에 우선순위를 설정하거나, 일시 중단 및 폐기할 수 있어, 애니메이션과 같은 우선도가 높은 작업을 먼저 처리하는 등 최적화된 순서로 작업을 처리할 수 있습니다.

## 📌 느낀점
React Fiber를 공부하면서 리액트 내부의 렌더링 방식이 어떻게 되는지 공부할 수 있었습니다. 객체로서 구현했다는 점이 신기했고 정말 복잡하게 이루어졌고 렌더링 최적화를 위해 설계한 사람들의 노력이 보이는 것 같아 대단했습니다. 아직 100%로 이해하진 못 한거 같아서 여러번 제가 쓴 것도 다시 읽어보고 자료도 더 찾아봐서 이해를 확실히 할 수 있게끔 해야 될 것 같습니다.
그리고 공부하면서도 이 Fiber Tree가 Virtual DOM 의 형태로 알면 되나 고민을 했었는데 리액트 팀은 이것을 Value UI라고 부르는 것을 권고한다고 합니다. 실제 Fiber Tree도 DOM이라고 하기엔 조금 부적절하다고 볼 수 있기에 이렇게 혼란을 방지하기 위해 Value UI라고 명칭을 붙인 것 같다고 생각하였습니다.

## 📌 참고
- https://m.blog.naver.com/dlaxodud2388/223195103660
- https://velog.io/@taemin-jang/React-Fiber
- https://wikibook.co.kr/react-deep-dive/










